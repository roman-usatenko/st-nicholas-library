<!DOCTYPE html>
<html ng-app="www">

<head>
    <title>Что? Где? Когда?</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/font-awesome.min.css">
    <link rel="stylesheet" href="css/main.css">
</head>

<body ng-controller="MainController">
    <div class="container text-center">

        <table style="margin-top: 10px; margin-bottom: 50px; width: 100%">
            <tr>
                <td valign="bottom" style="width:72px">
                    <button type="button" class="btn btn-warning btn-q" ng-click="onVolumeButtonClick()"
                        ng-show="showPlayerButtons">
                        <i ng-class="isVolumeButtonIncrease() ? 'fa fa-volume-down' : 'fa fa-volume-up'"
                            aria-hidden="true"></i>
                    </button>
                </td>
                <td>
                    <img class="img-fluid" src="img/logo.png">
                </td>
                <td valign="bottom" style="width:72px">
                    <button type="button" class="btn btn-danger btn-q" ng-click="stopPlayer()"
                        ng-show="showPlayerButtons">
                        <i class="fa fa-volume-off" aria-hidden="true"></i>
                    </button>
                </td>
            </tr>
        </table>

        <div ng-show="pages['Main']">
            <table style="width: 100%">
                <tr>
                    <td colspan="2">
                        <button type="button" class="btn btn-default btn-block btn-lg" ng-click="playAudio('auIntro')">
                            Вступление
                        </button>
                    </td>
                </tr>
                <tr>
                    <td style="padding-right: 10px">
                        <button type="button" class="btn btn-primary btn-block btn-lg" ng-click="playAudio('auRound')">
                            Гонг и волчок
                        </button>
                    </td>
                    <td style="padding-left: 10px">
                        <button type="button" class="btn btn-default btn-block btn-lg"
                            ng-click="playAudio('auBlackBox')">
                            Чёрный ящик
                        </button>
                    </td>
                </tr>
                <tr>
                    <td style="padding-right: 10px">
                        <button type="button" class="btn btn-primary btn-lg btn-block"                             ng-click="setTimerOn(60)">
                            Минута!
                        </button>
                    </td>
                    <td style="padding-left: 10px">
                        <button type="button" class="btn btn-primary btn-lg btn-block"                             ng-click="setTimerOn(20)">
                            20 секунд!
                        </button>
                    </td>
                </tr>
                <tr>
                    <td style="padding-right: 10px">
                        <button type="button" class="btn btn-success btn-lg btn-block"
                            ng-click="playAudio('auCorrect')">
                            +1 Знатокам
                        </button>
                    </td>
                    <td style="padding-left: 10px">
                        <button type="button" class="btn btn-danger btn-lg btn-block" ng-click="playAudio('auLoser')">
                            +1 Ведущему
                        </button>
                    </td>
                </tr>
            </table>
        </div>

        <div ng-show="pages['Timer']">
            <div class="card text-left">
                <div class="card-body">
                    <div style="text-align: center">
                        <h1>{{time}}</h1>
                    </div>
                </div>
                <div class="card-footer text-center">
                    <button type="button" class="btn btn-primary btn-lg btn-block" ng-click="setTimerOn(0)">
                        Остановить таймер
                    </button>
                </div>
            </div>
        </div>

        <audio id="auIntro" src="audio/intro.mp3" preload="auto" />
        <audio id="auRound" src="audio/round.mp3" preload="auto" />
        <audio id="auCorrect" src="audio/correct.mp3" preload="auto" />
        <audio id="auLoser" src="audio/loser.mp3" preload="auto" />
        <audio id="auBlackBox" src="audio/blackbox.mp3" preload="auto" />
        <audio id="auTime" src="audio/time.mp3" preload="auto" />
        <audio id="auTimeLast" src="audio/time-last.mp3" preload="auto" />
        <audio id="auTimeUp" src="audio/time-up.mp3" preload="auto" />

        <script src="js/jquery.min.js"></script>
        <script src="js/bootstrap.min.js"></script>
        <script src="js/angular.min.js"></script>

        <script>
            var STOPPABLE_AUDIO = ["auIntro", "auRound", "auCorrect", "auLoser", "auBlackBox"];
            var app = angular.module('www', []);
            app.controller('MainController', function ($scope, $interval, $http) {

                $scope.pages = {
                    "Main": true,
                    "Timer": false
                };

                $scope.time = 0;
                $scope.timerOn = false;

                $scope.player = null;
                $scope.showPlayerButtons = false;
                $scope.playerStopping = false;
                $scope.playerDesiredVolume = 1;

                $scope.playAudio = function (audio, volume = 1) {
                    $scope.playerStopping = false;
                    if ($scope.player != null) {
                        $scope.player.pause();
                    }
                    $scope.player = document.getElementById(audio);
                    $scope.playerDesiredVolume = volume;
                    $scope.player.volume = volume;
                    $scope.player.currentTime = 0;
                    $scope.player.play();
                };

                $scope.setPlayerVolume = function (volume) {
                    $scope.playerDesiredVolume = volume;
                };

                $scope.isVolumeButtonIncrease = function () {
                    return $scope.playerDesiredVolume < 1;
                };

                $scope.onVolumeButtonClick = function () {
                    if ($scope.isVolumeButtonIncrease()) {
                        $scope.setPlayerVolume(1);
                    } else {
                        $scope.setPlayerVolume(0.3);
                    }
                };

                $scope.stopPlayer = function () {
                    $scope.setPlayerVolume(0.001);
                    $scope.playerStopping = true;
                };

                $interval(function () {
                    $scope.showPlayerButtons =
                        $scope.player != null
                        && !$scope.playerStopping
                        && !$scope.player.ended
                        && (STOPPABLE_AUDIO.indexOf($scope.player.id) != -1);
                    if ($scope.player) {
                        var delta = $scope.player.volume - $scope.playerDesiredVolume;
                        if (delta != 0) {
                            if (Math.abs(delta) < 0.001) {
                                $scope.player.volume = $scope.playerDesiredVolume;
                            } else {
                                delta /= 7.0;
                                $scope.player.volume -= delta;
                            }
                        }
                        if ($scope.playerStopping && $scope.player.volume <= $scope.playerDesiredVolume) {
                            $scope.playerStopping = false;
                            $scope.player.pause();
                            $scope.player = null;
                        }
                    }
                }, 100);

                $scope.goToPage = function (page) {
                    for (var key in $scope.pages) {
                        if ($scope.pages.hasOwnProperty(key)) {
                            $scope.pages[key] = key == page;
                        }
                    }
                };

                $scope.setTimerOn = function (time) {
                    $scope.time = time;
                    if (time > 0) {
                        $scope.goToPage('Timer');
                        $scope.timerOn = true;
                        $scope.playAudio("auTime");
                        window.scrollTo(0, document.body.scrollHeight);
                    } else {
                        $scope.timerOn = false;
                        $scope.playAudio("auTimeUp");
                        $scope.goToPage('Main');
                    }
                };

                $interval(function () {
                    if ($scope.timerOn && $scope.time > 0) {
                        if ($scope.time <= 10) {
                            $scope.playAudio("auTimeLast", 0.2);
                        }
                        $scope.time -= 1;
                    } else if ($scope.timerOn) {
                        $scope.timerOn = false;
                        $scope.playAudio("auTimeUp");
                        $scope.goToPage('Main');
                    }
                }, 1000);
            });
        </script>

</body>

</html>